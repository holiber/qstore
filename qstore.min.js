/*!
* Qstore
* v0.7.9
*
* smart tool for work with collections
* @license Licensed under the MIT license.
* @see http://github.com/holiber/qstore
*
* build at 2014-04-23 19:55
*/
var context="undefined"!=typeof window?window:{};!function(a){function b(a){return"[object Array]"===i.call(a)}function c(a){return"function"==typeof a}function d(a){if(!a||"[object Object]"!==i.call(a)||a.nodeType||a.setInterval)return!1;var b=h.call(a,"constructor"),c=h.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!c)return!1;var d;for(d in a);return void 0===d||h.call(a,d)}function e(){var a,c,f,g,h,i,j=arguments[0]||{},k=1,l=arguments.length,m=!1;for("boolean"==typeof j&&(m=j,j=arguments[1]||{},k=2),"object"!=typeof j&&"function"!=typeof j&&(j={});l>k;k++)if(null!=(a=arguments[k]))for(c in a)f=j[c],g=a[c],j!==g&&(m&&g&&(d(g)||(h=b(g)))?(h?(h=!1,i=f&&b(f)?f:[]):i=f&&d(f)?f:{},j[c]=e(m,i,g)):void 0!==g&&(j[c]=g));return j}function f(a,b,c){if(a)for(var d in a)b[d]="function"==typeof a[d]&&"function"==typeof c[d]&&k.test(a[d])?g(a[d],c[d]):a[d]}function g(a,b){return function(){var c=this._super;this._super=b;try{return a.apply(this,arguments)}finally{this._super=c}}}var h=Object.prototype.hasOwnProperty,i=Object.prototype.toString,j=function(){};j.extend=function(a,b){function c(){this.init&&this.init.apply(this,arguments)}var d=[];"[object Array]"=={}.toString.apply(arguments[0])&&(d=arguments[0],a=arguments[1],b=arguments[2]),c.prototype=j.inherit(this.prototype),c.prototype.constructor=c,c.extend=j.extend,f(b,c,this);for(var e=0;e<d.length;e++)f(d[e],c.prototype,this.prototype);return f(a,c.prototype,this.prototype),c};var k=/xyz/.test(function(){})?/\b_super\b/:/./;j.inherit=Object.create||function(a){function b(){}return b.prototype=a,new b};var l=function(a){var b={silent:!1,soft:!1};return 1==m.softMode&&"object"==typeof a&&b.soft!==!1&&(b.soft=!0),a===!0?b.soft=!0:e(b,a),b},m=a.Qstore=j.extend({init:function(a){this.changes={},this.softMode=m.softMode,this.sortFields=null,this.reduce=e({},a);var b=this.unpack(a);this.rows=b.rows,this.columns=b.columns,this.lastIdx=b.lastIdx,this.listener=function(){},this.computed={},this.defaults={}},size:function(){return this.rows&&this.rows.length||0},unpack:function(a){var c={columns:["idx"],rows:[],lastIdx:1};if(!a)return c;if(b(a)){if(!a.length)return c;var d=a[0],f=["idx"],g=1,h=[];for(var i in d)f.push(i);for(var j=0;j<a.length;j++){var k=e({idx:g},a[j]);h.push(k),g++}return{rows:h,columns:f,lastIdx:g}}if(!a.columns)return c;for(var f=["idx"].concat(a.columns),g=1,h=[],j=0;j<a.rows.length;j++){for(var k={idx:g},l=0;l<a.columns.length;l++)k[a.columns[l]]=a.rows[j][l];h.push(k),g++}return{rows:h,columns:f,lastIdx:g}},pack:function(a,b){var c=b||this.columns,d=a?this.find(a):this.rows,e=[];for(var f in d){for(var g=d[f],h=[],i=0;i<c.length;i++)h.push(g[c[i]]);e.push(h)}return{columns:c,rows:e}},find:function(a,b,c){return m.findIn(this.rows,a,b,c)},search:function(a,b,c){return new this.constructor(this.find(a,b,c))},findOne:function(a,b,c){return c=c||{},c=e({},{limit:1},c),this.find(a,b,c)[0]},indexBy:function(a,b){return m.indexBy(this.rows,a,b)},mapOf:function(a,b){return m.mapOf(this.rows,a,b)},groupBy:function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this.rows),new m(m.groupBy.apply(m,a))},each:function(a,b){b||(b=a);var c=this.find(a,{goNext:b});return c.length},getList:function(a,b){return m.getList(this.rows,a,b)},fire:function(a,b){this.listener(a,b,this)},sort:function(a,d){if(!a)return!1;if(c(a))return this.rows.sort(a),this.fire("sort",a),void 0;for(var e=b(a)?a:[a],f=this,g=0;g<e.length;g++){var h=e[g];if("string"==typeof h){h=h.split(":");var i=h[1]||"asc";e[g]={fieldName:h[0],order:i}}}this.sortFields=e||this.sortFields||[{fieldName:"idx",order:"asc"}];var j=function(a,b,c){c=c||0;var e=void 0!==f.sortFields[c].zeroIsLast?f.sortFields[c].zeroIsLast:d,g=f.sortFields[c].fieldName;if(e&&a[g]!==b[g]){if(!a[g])return 1;if(!b[g])return-1}if(a[g]==b[g]){var h=f.sortFields[c+1];if(!h)return a.idx-b.idx;var i=h.order||"asc";return"asc"==i?j(a,b,c+1):k(a,b,c+1)}return a[g]<b[g]?-1:a[g]>b[g]?1:"number"==typeof a[g]||"number"==typeof b[g]?"number"==typeof a[g]?1:-1:"string"==typeof a[g]||"string"==typeof b[g]?"string"==typeof a[g]?-1:1:a.idx-b.idx},k=function(a,b,c){c=c||0;var e=void 0!==f.sortFields[c].zeroIsLast?f.sortFields[c].zeroIsLast:d,g=f.sortFields[c].fieldName;if(e&&a[g]!==b[g]){if(!a[g])return-1;if(!b[g])return 1}if(a[g]==b[g]){var h=f.sortFields[c+1];if(!h)return b.idx-a.idx;var i=h.order||"asc";return"asc"==i?j(a,b,c+1):k(a,b,c+1)}return a[g]<b[g]?1:a[g]>b[g]?-1:"number"==typeof a[g]||"number"==typeof b[g]?"number"==typeof a[g]?-1:1:"string"==typeof a[g]||"string"==typeof b[g]?"string"==typeof a[g]?1:-1:b.idx-a.idx},l=this.sortFields[0];return l.order=l.order||"asc","desc"==l.order?this.rows.sort(k):this.rows.sort(j),this.fire("sort",a),this},update:function(a,b,d){for(var f=b?a:null,g=b?b:a,h="boolean"==typeof b?b:d,i=l(h),j=0,k=[],n=0;n<this.rows.length;n++){var o=this.rows[n];if(!f||m.test(o,f)){var p=c(g)?g(o):g;if(!p)continue;j++;var q=this.changes[o.idx]||{},r={action:"update",source:q.source||e({},o),values:e({},q.values||{},p),current:null};for(var s in p)o[s]=p[s];r.current=o,i.soft||(k.push(e({},r,{patch:p})),this.changes[o.idx]=r)}}return this.compute(),k=new m(k),i.silent||this.fire("change",{action:"update",changes:k}),j},patch:function(a,b,c){if(b=b||"idx",!a)return 0;for(var d={},f=0;f<a.length;f++)d[a[f][b]]=a[f];this.update(function(a){if(!d[a[b]])return!1;var c=e({},d[a[b]]);return delete c[b],c},c)},add:function(a,c){a=b(a)?a:[a];for(var d=l(c),e=[],f=[],g=0;g<a.length;g++){var h=a[g];for(var i in this.defaults)void 0===h[i]&&(h[i]=this.defaults[i]);h.idx=++this.lastIdx;var j={action:"add",values:h};d.soft||(this.changes[h.idx]=j),f.push(j),e.push(h)}return this.rows=e.concat(this.rows),this.compute(),this.sortFields=null,d.silent||this.fire("change",f),!0},remove:function(a,b){for(var c=l(b),d=[],e=0,f=0;f<this.rows.length;f++){var g=this.rows[f];m.test(g,a)&&(e++,c.soft?this.changes[g.idx]&&delete this.changes[g.idx]:this.changes[g.idx]?this.changes[g.idx].action="remove":this.changes[g.idx]={action:"remove",source:g},d.push(this.changes[g.idx]),this.rows.splice(f,1),f--)}return c.silent||this.fire("change",{action:"remove",changes:d}),e},rollback:function(){for(var a=this.rows.length;a--;){var b=this.rows[a],c=this.changes[b.idx];if(c)switch(c.action){case"update":this.rows[a]=c.source;break;case"add":this.rows.splice(a,1)}}for(var d in this.changes){var c=this.changes[d];"remove"==c.action&&this.rows.push(c.source)}this.fire("change",{action:"rollback",changes:e({},this.changes)}),this.changes={}},commit:function(a){var b=this.changes.length;return a||this.fire("commit"),this.changes={},b},addFields:function(a){a instanceof Array||(a=[a]);var b=a.length,c=[];if(!b)return!1;for(var d=0;b>d;d++){var f=e({name:!1,compute:!1},"string"==typeof a[d]?{name:a[d]}:a[d]);if(f.name){var g=!1,h=~this.columns.indexOf(f.name);h||(g=!0,this.columns.push(f.name)),f.compute&&(this.computed[f.name]=f.compute),void 0!=f.default&&(this.defaults[f.name]=f.default,g&&c.push(f.name))}}if(c.length)for(var d=0;d<this.rows.length;d++)for(var i=this.rows[d],j=0;j<c.length;j++){var k=c[j];void 0===i[k]&&(i[k]=this.defaults[k])}return this.compute(),this.fire("change",{action:"addFields",fields:a}),!0},compute:function(){for(var a=this.size();a--;)for(var b=this.columns.length;b--;){var c=this.columns[b];this.computed[c]?this.rows[a][c]=this.computed[c](this.rows[a]):void 0===this.rows[a][c]&&(this.rows[a][c]="")}},getCopy:function(b){var c=this.rows;b&&(c=this.find(b));var d=new a.Qstore(JSON.parse(JSON.stringify({columns:this.columns,rows:[]})));return d.rows=JSON.parse(JSON.stringify(c)),d.lastIdx=this.lastIdx,d},removeFields:function(a){if(a){a instanceof Array||(a=[a]);for(var b=0;b<a.length;b++){var c=a[b],d=this.columns.indexOf(c);~d&&this.columns.splice(d,1),delete this.computed[c],delete this.defaults[c]}for(var b=0;b<this.rows.length;b++)for(var e=0;e<a.length;e++){var c=a[e];delete this.rows[b][c]}this.fire("change",{action:"removeFields",fields:a})}},getChanges:function(){if(this.changes.length)return null;var a=[];for(var b in this.changes){var c=this.changes[b];c.idx=b,a.push(c)}return new m(a)},getChangesMap:function(a){a=a||"idx";var b=this.getChanges(),c={};return c.add=b.find({action:"add"},["values:"]),c.remove=b.search({action:"remove"}).getList("source."+a),c.update=b.find(!0,["source."+a+":"+a,"values:"]),c},setListener:function(a){this.listener=a},setSoftMode:function(a){this.softMode=a}},{Class:j,extend:e,operators:{},functions:{},softMode:!1,len:function(a){if(a.length)return a.length;var b=0;for(var c in a)b++;return b},first:function(a){if("string"==typeof a)return a.charAt(0);if(a instanceof Array)return a[0];if(a instanceof Object)for(var b in a)return a[b];return a},addOperator:function(a,b,c){void 0===c&&(c=!0),this.operators[a]={fn:b,isSimple:c}},removeOperator:function(a){delete this.operators[a]},addFunction:function(a,b){this.functions[a]=b},removeFunction:function(a){delete this.functions[a]},test:function(a,b,c,d){if(d||(d={item:a}),c&&"$and"!=c||"object"!=typeof b&&"function"!=typeof b){if("string"==typeof b&&"$"==b.charAt(0)&&"."==b.charAt(1)){var f=b.substr(2);b=m.getVal(d.item,f)}switch(c=c||"$eq"){case"$eq":return a==b;case"$ne":return a!=b;case"$gt":return a>b;case"$lt":return b>a;case"$gte":return a>=b;case"$lte":return b>=a;case"$like":return null!==a?~String(a).toLowerCase().indexOf(b.toLowerCase()):!1;default:var g=c.split("$")[1],h=m.operators[g].fn;if(!h)throw"operator "+g+" not found";return h(a,b,d)}}if(a instanceof Array){for(var i=0;i<a.length;i++)if(this.test(a[i],b,null,e({},d,{currentItem:a})))return!0;return!1}if("$and"==c){for(var j=0;j<b.length;j++)if(!this.test(a,b[j],null,d))return!1;return!0}if(b instanceof RegExp)return b.test(String(a));if(b instanceof Array){for(var j=0;j<b.length;j++)if(this.test(a,b[j],null,d))return!0;return!1}if("object"==typeof b){for(var j in b)if("$and"!=j)if("string"!=typeof j||"$"!=j.charAt(0)){if("string"==typeof j&&"$"==j.charAt(0)&&"."!=j.charAt(1)){var g=m.operators[j.split("$")[1]];if(g&&g.isSimple===!1){if(!g.fn(d.currentItem,b[j],d))return!1;continue}}if("object"!=typeof a)return!1;if(!this.test(m.getVal(a,j),b[j],null,d))return!1}else{var g=m.operators[j.split("$")[1]];if(g&&g.isSimple===!1)return g.fn(d.currentItem,b[j],d);if(!this.test(a,b[j],j,d))return!1}else if(!this.test(a,b[j],j,d))return!1;return!0}return"function"==typeof b?b(a):!1},findIn:function(a,b,c,d){if(!a)throw"empty data";if(void 0===b)b=!0;else if(!b)return[];c=c||!0,d=d||{};var e=d.limit,f=d.goNext;"number"==typeof e&&(e=[1,e]);for(var g=[],h=0,i=0;i<a.length;i++){var j=a[i];if(e&&h>=e[1])break;if(b===!0||m.test(j,b)){if(h++,f&&f(j,h,b)===!1)break;e&&h<e[0]||(c===!0?g.push(j):g.push(m.getFields(j,c,{})))}}return g},getList:function(a,b,c){("string"==typeof b||"function"==typeof b)&&(c=b,b=null),c=c||"idx";var d=[];a=b?m.findIn(a,b):a;for(var e=0;e<a.length;e++){var f=m.getVal(a[e],c);~d.indexOf(f)||d.push(f)}return d},indexBy:function(a,b,c){c=e({},{alwaysWrap:!1,undefinedKey:!1},c);var d={};b instanceof Array||(b=[b]);for(var f=b[0],g=0;g<a.length;g++){var h=a[g],i="function"==typeof f?f(h):m.getVal(h,f);if(0!==i&&!i){if(!c.undefinedKey)continue;i=c.undefinedKey}c.alwaysWrap?(d[i]||(d[i]=[]),d[i].push(h)):d[i]?d[i]instanceof Array?d[i].push(h):d[i]=[d[i],h]:d[i]=h}var j=b.splice(1);if(j.length)for(var k in d){var l=d[k]instanceof Array?d[k]:[d[k]];d[k]=m.indexBy(l,j,c)}return d},groupBy:function(){for(var a=Array.prototype.slice.call(arguments),b=a[0],c=a.splice(1),d=c[0],f=[],g="string"==typeof d?[d]:d,h=m.getAdditionalFields(g),i=0;i<b.length;i++){var j=b[i],k=m.getFields(j,g),l=m.findIn(f,k,!0,{limit:1})[0];l?l._g.push(j):(k._g=[j],f.push(k))}var n=c.splice(1);if(n.length)for(var i=0;i<f.length;i++){var o=f[i],p=[o._g].concat(n);o._g=m.groupBy.apply(m,p)}if(h)for(var i=0;i<f.length;i++){var o=f[i],q=m.getFields(o,h);e(o,q)}return f},mapOf:function(a,b,c){return m.indexBy(a,b,e({},{alwaysWrap:!0},c))},flatten:function(){},parseArgs:function(a){for(var b=a.split(","),c=[],d=0;d<b.length;d++){var e=b[d].trim();'"'==e.charAt(0)&&'"'==e.charAt(e.length-1)||"'"==e.charAt(0)&&"'"==e.charAt(e.length-1)?c.push(e.substr(1,e.length-2)):/^[\d\.]+$/.test(e)?c.push(Number(e)):"["==e.charAt(0)&&"]"==e.charAt(e.length-1)||"{"==e.charAt(0)&&"}"==e.charAt(e.length-1)?c.push(JSON.parse(e)):c.push(e)}return c},getFields:function(a,b){var c=[],d={};if("object"!=typeof b&&(b=[b]),b instanceof Array)for(var e=b.length;e--;)c.push(m.getField(a,b[e]));else for(var f in b)"$add"!=f&&c.push(m.getField(a,f,b[f]));for(var e=0;e<c.length;e++){var g=c[e];for(var h in g)d[h]=g[h]}return d},getField:function(a,b,c){var d;if("function"==typeof b)return b(a);"string"==typeof c&&(d=b,b=c);var e={},f=b.split(":");d=d||f[1],b=f[0];var g=""===d,h=d||b,i=m.getVal(a,b,c);if(g&&"object"==typeof i)for(var j in i)e[j]=i[j];else e[h]=i;return e},getVal:function(a,b,c){if("function"==typeof b)return b(a,c);for(var d=b.split("."),e=a,f=0;f<d.length;f++){var g=d[f],h="$"==g.charAt(0);if(h){var i=g.split("$")[1].split("("),j=i[0],k=i[1]?i[1].substr(0,i[1].length-1):null,l=this.functions[j];if(!l)throw"function "+j+" not found";e=k?l(e,k):l(e)}else e=e[g]}return"function"==typeof c&&(e=c(a,e)),e},getAdditionalFields:function(a){var b=function(a){for(var b in a)if("$add"==b){var c=a[b];return c}return!1};if(a instanceof Array)for(var c=0;c<a.length;c++){var d=a[c];if("object"==typeof d){var e=b(d);if(e)return e}}return"object"==typeof a?b(a):void 0},setSoftMode:function(a){this.softMode=a}}),n={length:function(a){return m.len(a)},max:function(a){if(a instanceof Array){for(var b=-1/0,c=a.length;c--;)b=Math.max(b,a[c]);return b}},min:function(a){if(a instanceof Array){for(var b=1/0,c=a.length;c--;)b=Math.min(b,a[c]);return b}},abs:function(a){return Math.abs(a)},first:function(a){return m.first(a)},find:function(a,b){return b=m.parseArgs(b),b.unshift(a),m.findIn.apply(m,b)},mapOf:function(a,b){return m.mapOf(a,b)},indexBy:function(a,b){return m.indexBy(a,b)},test:function(a,b){return m.test(a,b)},getList:function(a,b){return b=m.parseArgs(b),b.unshift(a),m.getList.apply(m,b)},upper:function(a){return String(a).toUpperCase()},lower:function(a){return String(a).toLowerCase()},toNumber:function(a){return Number(a)},toString:function(a){return String(a)}},o={has:{isSimple:!1,fn:function(a,b){if("object"==typeof b)return m.findIn(a,b).length;if(a instanceof Array)if(b instanceof Array){for(var c=0;c<a.length;c++)if(~b.indexOf(a[c]))return!0}else if(~a.indexOf(b))return!0;return"object"==typeof a?void 0!==a[b]?!0:!1:"string"==typeof a?!!~a.indexOf(b):!1}}};for(var p in n)m.addFunction(p,n[p]);for(var p in o)m.addOperator(p,o[p].fn,o[p].isSimple)}(context),"undefined"!=typeof module&&module.exports&&(module.exports=context.Qstore);